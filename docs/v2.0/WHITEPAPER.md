# SQLRustGo 2.0 白皮书

> 版本：v1.0
> 日期：2026-02-18
> 状态：设计文档

---

## 摘要

SQLRustGo 是一个用 Rust 编写的嵌入式 SQL 数据库内核，目标是提供一个轻量级、高性能、可插拔的 SQL 执行引擎。本文档描述了 2.0 版本的架构设计、优化器设计、执行引擎和扩展能力。

---

## 1. Vision

### 1.1 核心定位

**嵌入式 Rust SQL 内核**

- 轻量级：无外部依赖，可嵌入任何 Rust 项目
- 高性能：向量化执行，充分利用现代 CPU
- 可插拔：插件化架构，支持自定义存储、函数、优化规则

### 1.2 设计目标

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          设计目标                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   🎯 轻量级                                                                 │
│   ├── 单二进制文件                                                          │
│   ├── 无外部依赖                                                            │
│   └── 最小内存占用                                                          │
│                                                                              │
│   🚀 高性能                                                                 │
│   ├── 向量化执行                                                            │
│   ├── 并行处理                                                              │
│   └── 零拷贝设计                                                            │
│                                                                              │
│   🔌 可插拔                                                                 │
│   ├── 存储插件                                                              │
│   ├── 函数插件                                                              │
│   └── 优化规则插件                                                          │
│                                                                              │
│   📚 教学友好                                                               │
│   ├── 清晰的架构分层                                                        │
│   ├── 完整的文档                                                            │
│   └── 可读的代码                                                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 架构设计

### 2.1 分层架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          架构分层                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                          API Layer                                   │   │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐                           │   │
│   │  │  Query   │  │  DDL     │  │  DML     │                           │   │
│   │  └──────────┘  └──────────┘  └──────────┘                           │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                   │                                          │
│                                   ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        Parser Layer                                  │   │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐                           │   │
│   │  │  Lexer   │  │  Parser  │  │   AST    │                           │   │
│   │  └──────────┘  └──────────┘  └──────────┘                           │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                   │                                          │
│                                   ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        Planner Layer                                 │   │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐                           │   │
│   │  │ Analyzer │  │ Logical  │  │ Physical │                           │   │
│   │  └──────────┘  └──────────┘  └──────────┘                           │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                   │                                          │
│                                   ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                       Optimizer Layer                                │   │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐                           │   │
│   │  │   RBO    │  │   CBO    │  │  Stats   │                           │   │
│   │  └──────────┘  └──────────┘  └──────────┘                           │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                   │                                          │
│                                   ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                       Executor Layer                                 │   │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐                           │   │
│   │  │  Vector  │  │ Parallel │  │Pipeline  │                           │   │
│   │  └──────────┘  └──────────┘  └──────────┘                           │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                   │                                          │
│                                   ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        Storage Layer                                 │   │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐                           │   │
│   │  │  Memory  │  │   File   │  │    S3    │                           │   │
│   │  └──────────┘  └──────────┘  └──────────┘                           │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 插件模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          插件模型                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                       Plugin Registry                                │   │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │   │
│   │  │ Storage  │  │ Function │  │Optimizer │  │ Executor │            │   │
│   │  │ Plugins  │  │ Plugins  │  │ Plugins │  │ Plugins │            │   │
│   │  └──────────┘  └──────────┘  └──────────┘  └──────────┘            │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│   Storage Plugins:                                                         │
│   ├── MemoryStorage (内存存储)                                              │
│   ├── FileStorage (文件存储)                                                │
│   └── S3Storage (云存储)                                                    │
│                                                                              │
│   Function Plugins:                                                        │
│   ├── ScalarUDF (标量函数)                                                  │
│   └── AggregateUDF (聚合函数)                                               │
│                                                                              │
│   Optimizer Plugins:                                                       │
│   ├── PredicatePushdown (谓词下推)                                          │
│   ├── ProjectionPruning (投影裁剪)                                          │
│   └── JoinReorder (Join 重排序)                                             │
│                                                                              │
│   Executor Plugins:                                                        │
│   ├── DefaultExecutor (默认执行器)                                          │
│   ├── ParallelExecutor (并行执行器)                                         │
│   └── VectorizedExecutor (向量化执行器)                                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 执行模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          执行模型                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   SQL String                                                                │
│       │                                                                      │
│       ▼                                                                      │
│   ┌─────────────┐                                                           │
│   │   Parser    │  → AST                                                    │
│   └─────────────┘                                                           │
│       │                                                                      │
│       ▼                                                                      │
│   ┌─────────────┐                                                           │
│   │   Binder    │  → LogicalPlan                                            │
│   └─────────────┘                                                           │
│       │                                                                      │
│       ▼                                                                      │
│   ┌─────────────┐                                                           │
│   │  Optimizer  │  → Optimized LogicalPlan                                  │
│   └─────────────┘                                                           │
│       │                                                                      │
│       ▼                                                                      │
│   ┌─────────────┐                                                           │
│   │  Physical   │  → PhysicalPlan                                           │
│   │  Planner    │                                                           │
│   └─────────────┘                                                           │
│       │                                                                      │
│       ▼                                                                      │
│   ┌─────────────┐                                                           │
│   │  Executor   │  → RecordBatch Stream                                     │
│   └─────────────┘                                                           │
│       │                                                                      │
│       ▼                                                                      │
│   QueryResult                                                               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 优化器设计

### 3.1 RBO（规则优化器）

| 规则 | 说明 |
|:-----|:-----|
| PredicatePushdown | 谓词下推到存储层 |
| ProjectionPruning | 裁剪不需要的列 |
| ConstantFolding | 常量折叠 |
| ExpressionSimplification | 表达式简化 |

### 3.2 CBO（成本优化器）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          CBO 架构                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   Statistics（统计信息）                                                    │
│   ├── TableStats: row_count, total_bytes                                   │
│   └── ColumnStats: distinct_count, null_count, min, max                    │
│                                                                              │
│   Cost Model（成本模型）                                                    │
│   ├── CPU Cost: 操作计算量                                                  │
│   ├── I/O Cost: 磁盘访问量                                                  │
│   └── Memory Cost: 内存使用量                                               │
│                                                                              │
│   Plan Enumerator（计划枚举器）                                             │
│   ├── Join Reorder (DP 算法)                                                │
│   ├── Access Path Selection                                                 │
│   └── Join Algorithm Selection                                              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Join DP 算法

```
dp[S] = 最优子计划

初始化：
dp[{T}] = Scan(T)

递推：
dp[S] = min(dp[S1] ⋈ dp[S2])

时间复杂度：O(n² × 2ⁿ)
适合：≤ 10 张表
```

---

## 4. 执行引擎

### 4.1 行模式 vs 向量化

| 特性 | 行模式 | 向量化 |
|:-----|:-------|:-------|
| 处理单位 | 单行 | 批量（1024行） |
| CPU 缓存 | 差 | 好 |
| SIMD | 不可用 | 可用 |
| 性能 | 基准 | 10-20x 提升 |

### 4.2 批处理 Pipeline

```
ScanExec → FilterExec → ProjectionExec → AggregateExec

每个 Operator 处理 RecordBatch
```

### 4.3 向量化表达式

```rust
pub trait PhysicalExpr {
    fn evaluate(&self, batch: &RecordBatch) -> Result<ArrayRef>;
}

// 批量计算
fn evaluate(batch: &RecordBatch) -> Result<ArrayRef> {
    let left = self.left.evaluate(batch)?;
    let right = self.right.evaluate(batch)?;
    vectorized_compute(&left, &right, self.op)
}
```

---

## 5. 扩展能力

### 5.1 多存储支持

| 存储 | 说明 |
|:-----|:-----|
| MemoryStorage | 内存存储，适合测试 |
| FileStorage | 文件存储，适合单机 |
| S3Storage | 云存储，适合分布式 |

### 5.2 UDF 支持

```rust
pub trait ScalarUDF {
    fn name(&self) -> &str;
    fn signature(&self) -> &Signature;
    fn return_type(&self, args: &[DataType]) -> Result<DataType>;
    fn invoke(&self, args: &[ArrayRef]) -> Result<ArrayRef>;
}
```

### 5.3 分布式接口

```rust
pub trait DistributedExecutor {
    fn execute(&self, plan: &PhysicalPlan) -> Result<DistributedResult>;
}

pub trait Scheduler {
    fn schedule(&self, task: Task) -> Result<TaskHandle>;
}
```

---

## 6. Roadmap

### 6.1 v2.0 — 内核重构

**时间**：1-2 个月

| 任务 | 说明 |
|:-----|:-----|
| LogicalPlan 重构 | 独立模块 |
| PhysicalPlan trait | 可扩展设计 |
| Executor 插件化 | 可替换执行器 |
| HashJoin | 解决 Join 性能 |

**目标**：L3 结构化内核

### 6.2 v2.1 — 性能升级

**时间**：2-3 个月

| 任务 | 说明 |
|:-----|:-----|
| 向量化执行 | 批量处理 |
| 统计信息 | 表/列统计 |
| 简化 CBO | 成本优化 |
| Join Reorder | DP 算法 |

**目标**：L4 高性能内核

### 6.3 v3.0 — 分布式

**时间**：6-12 个月

| 任务 | 说明 |
|:-----|:-----|
| 分布式执行 | 多节点 |
| Memory Pool | 内存管理 |
| Spill to Disk | 磁盘溢出 |
| 事务支持 | ACID |

**目标**：L5 企业级引擎

---

## 7. 总结

### 7.1 核心价值

```
SQLRustGo 2.0 将实现：

✅ 对标 Apache DataFusion 的架构设计
✅ 向量化执行带来的 10-20x 性能提升
✅ 插件化架构带来的可扩展性
✅ 完整的 CBO 优化器
```

### 7.2 适用场景

| 场景 | 说明 |
|:-----|:-----|
| 嵌入式数据库 | 嵌入 Rust 应用 |
| 数据分析 | OLAP 查询 |
| 教学学习 | 数据库内核学习 |
| 原型开发 | 快速验证想法 |

---

*本文档由 TRAE (GLM-5.0) 创建*
