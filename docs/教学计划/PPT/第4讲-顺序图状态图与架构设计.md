---
marp: true
theme: gaia
paginate: true
backgroundColor: #fff
color: #333
---

<!-- _class: lead -->

# 第四讲：顺序图、状态图与架构设计

## AI增强的软件工程

---

# 课程大纲

1. **顺序图**（20分钟）
2. **状态图**（20分钟）
3. **架构图与部署图**（25分钟）
4. **快速原型法**（25分钟）

---

# Part 1: 顺序图

---

## 1.1 顺序图的组成元素

### 对象（Object）/ 参与者

- 系统中的实体
- 用矩形框表示

### 生命线（Lifeline）

- 对象存在的时间段
- 用虚线表示

### 消息（Message）

- **同步消息**：实线箭头
- **异步消息**：实线开放箭头
- **返回消息**：虚线箭头

---

## 1.1 顺序图的组成元素（续）

### 激活（Activation）

- 对象正在执行操作的时间段
- 用细长矩形表示

### 组合片段（Combined Fragment）

- **alt**：条件分支
- **loop**：循环
- **opt**：可选

---

## 1.2 顺序图绘制规范

### 从左到右排列对象

- 发送者在左，接收者在右

### 消息从上到下按时间顺序

- 时间轴从上到下

### 命名清晰

- 消息名称使用动词短语
- 参数列表简洁明了

---

## 1.3 实例：SQL查询执行顺序图

```
Client        Parser        Executor       Storage
  │             │              │              │
  │──parse(sql)─>│              │              │
  │             │              │              │
  │<──Statement──│              │              │
  │             │              │              │
  │──execute(Statement)────────>│              │
  │             │              │              │
  │             │              │──read(table)─>│
  │             │              │              │
  │             │              │<───rows──────│
  │             │              │              │
  │<───────Result───────────────│              │
  │             │              │              │
```

---

# Part 2: 状态图

---

## 2.1 状态图的组成元素

### 状态（State）

- **初始状态**：实心圆点
- **终止状态**：实心圆点外加圆圈
- **中间状态**：圆角矩形

### 转换（Transition）

- 状态之间的变化
- 用箭头表示

### 事件（Event）

- 触发状态转换的条件

### 动作（Action）

- 状态转换时执行的操作

---

## 2.2 状态图绘制规范

### 状态命名清晰

- 使用名词短语
- 反映对象的状态

### 转换条件明确

- 格式：`事件 [条件] / 动作`

### 避免状态爆炸

- 只关注关键状态
- 合并相似状态

---

## 2.3 实例：事务状态图

```
    ┌─────────┐
    │  Idle   │
    └────┬────┘
         │ BEGIN
         ▼
    ┌─────────┐
    │ Active  │
    └────┬────┘
         │
    ┌────┴────┐
    │         │
    │ COMMIT  │ ROLLBACK
    ▼         ▼
┌──────────┐ ┌───────────┐
│Committed │ │Rolledback │
└──────────┘ └───────────┘
```

---

# Part 3: 架构图与部署图

---

## 3.1 架构图类型

### 分层架构图

- 展示系统的层次结构
- 每层有明确的职责

### 模块架构图

- 展示模块之间的依赖关系
- 模块是功能的逻辑分组

### 组件架构图

- 展示组件之间的交互
- 组件是可部署的单元

---

## 3.2 SQLRustGo四层架构

```
┌─────────────────────────────────────────────────────────┐
│                    Parser Layer                          │
│         Lexer → Parser → AST                             │
│         功能：SQL解析、语法检查                           │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                    Planner Layer                         │
│         Logical Plan → Physical Plan                     │
│         功能：查询优化、执行计划生成                      │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                    Executor Layer                        │
│         Volcano Model → Operators                        │
│         功能：查询执行、结果返回                          │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                    Storage Layer                         │
│         Page → BufferPool → B+Tree → WAL                 │
│         功能：数据存储、索引管理、事务支持                │
└─────────────────────────────────────────────────────────┘
```

---

## 3.3 部署图

### 节点（Node）

- 物理设备或执行环境
- 如：服务器、容器、进程

### 组件部署

- 组件部署到节点的映射
- 展示运行时架构

### 网络拓扑

- 节点之间的网络连接
- 通信协议

### SQLRustGo部署方案

```
┌──────────────────┐
│   Client App     │
│  (应用程序)       │
└────────┬─────────┘
         │ TCP/IP
         ▼
┌──────────────────┐
│  SQLRustGo       │
│  (数据库进程)     │
│  ┌────────────┐  │
│  │  Parser    │  │
│  │  Planner   │  │
│  │  Executor  │  │
│  │  Storage   │  │
│  └────────────┘  │
└────────┬─────────┘
         │ File I/O
         ▼
┌──────────────────┐
│  Data Files      │
│  (数据文件)       │
└──────────────────┘
```

---

# Part 4: 快速原型法

---

## 4.1 快速原型法的概念

### 什么是原型

- 系统的早期版本
- 用于验证需求和设计

### 原型的类型

- **抛弃型原型**：验证后丢弃
- **演化型原型**：逐步完善成最终产品

### 原型法的优缺点

- ✅ **优点**：快速验证、降低风险、用户参与
- ⚠️ **缺点**：可能质量不高、需要额外成本

---

## 4.2 原型法开发流程

```
需求分析 → 快速设计 → 原型构建 → 用户评估 → 迭代改进
    ↑                                              │
    └──────────────────────────────────────────────┘
```

### 每个阶段的产物

| 阶段 | 产物 |
|------|------|
| 需求分析 | 需求文档、用例图 |
| 快速设计 | 架构图、类图 |
| 原型构建 | 可运行的原型代码 |
| 用户评估 | 评估报告、反馈意见 |
| 迭代改进 | 改进计划、新版本原型 |

---

## 4.3 SQLRustGo草稿版本分析

### 项目实施计划

- 定义项目范围和目标
- 规划开发阶段和里程碑

### 核心类型系统

- Value枚举定义
- DataType枚举定义
- SqlError错误类型

### 词法/语法分析器原型

- Lexer基础实现
- Parser基础实现
- AST节点定义

---

## 4.3 SQLRustGo草稿版本分析（续）

### 存储引擎基础结构

- Page结构定义
- BufferPool基础实现
- 简单的文件存储

### 草稿版本作为抛弃型原型的意义

- **验证架构设计**
- **识别技术难点**
- **快速迭代改进**
- **为Alpha版本奠定基础**

---

## 4.4 AI辅助快速原型开发

### 使用AI快速生成原型代码

```
为SQLRustGo生成词法分析器原型，要求：
1. 支持基本的SQL关键字
2. 支持标识符和字面量
3. 使用Rust实现
4. 代码简洁，便于理解
```

### 使用AI生成设计文档

```
为SQLRustGo生成架构设计文档，要求：
1. 描述四层架构
2. 说明每层的职责
3. 列出核心组件
4. 使用Markdown格式
```

### 原型评估和迭代

- AI可以辅助评估原型质量
- AI可以建议改进方向
- AI可以生成测试用例

---

# 核心知识点总结

---

## 1. 顺序图

- **对象、生命线、消息、激活**
- **同步/异步消息**
- **SQL查询执行流程建模**

## 2. 状态图

- **状态、转换、事件、动作**
- **事务状态建模**

## 3. 架构设计

- **分层架构**
- **SQLRustGo四层架构**
- **部署图**

## 4. 快速原型法

- **原型类型**：抛弃型 vs 演化型
- **开发流程**
- **AI辅助原型开发**

---

# 课后作业

---

## 任务

1. 完成SQLRustGo顺序图（至少2个场景）
2. 完成事务状态图
3. 绘制系统架构图
4. 编写快速原型设计文档

## 预习

- 架构设计原理
- 功能模块划分

---

<!-- _class: lead -->

# 谢谢！

## 下节课：架构设计原理与SQLRustGo架构
